# OpenMeet Platform - Local Development with Docker
# ==================================================
#
# Quick start:
#   docker compose -f docker-compose-dev.yml up
#   Open http://localhost:9005
#
# To use remote dev API (no local API needed):
#   BACKEND_DOMAIN=https://api-dev.openmeet.net docker compose -f docker-compose-dev.yml up
#
# This runs:
#   - Quasar dev server with hot reload
#   - Nginx reverse proxy (similar to production)
#
# By default, connects to local API in Docker on shared api-network.
# See BACKEND_DOMAIN options below for other configurations.

services:
  # Quasar dev server with hot reload (internal service)
  platform-dev:
    image: node:24-alpine
    container_name: platform-dev
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    volumes:
      - .:/app
      - /app/node_modules  # Prevent overwriting host node_modules
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    networks:
      - api-network

  # Nginx with bot detection (production-like entry point)
  platform-nginx:
    image: nginx:1.25-alpine
    container_name: platform-nginx
    ports:
      - "9005:80"
    volumes:
      - ./nginx-dev.conf.template:/etc/nginx/templates/default.conf.template:ro
    environment:
      # BACKEND_DOMAIN: Where nginx proxies API requests for bot detection
      # Default: local API in Docker. Override with env var:
      #   BACKEND_DOMAIN=https://api-dev.openmeet.net docker compose ...
      #   BACKEND_DOMAIN=http://host.docker.internal:3000 docker compose ...
      - BACKEND_DOMAIN=${BACKEND_DOMAIN:-http://api:3000}
      - QUASAR_DEV_HOST=platform-dev:9005
      - APP_TENANT_ID=${APP_TENANT_ID}
      # X-Robots-Tag: block local dev from search engine indexing
      # Set to "false" to allow indexing (only needed for prod)
      - APP_NOINDEX=${APP_NOINDEX:-true}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allows nginx to reach host machine
    depends_on:
      - platform-dev
    networks:
      - api-network

networks:
  # Shared network with openmeet-api (must exist)
  # Create if needed: docker network create api-network
  api-network:
    name: api-network
    external: true
