# OpenMeet Platform - Local Development with Docker
# ==================================================
#
# Quick start:
#   docker compose -f docker-compose-dev.yml up
#   Open http://localhost:9005
#
# This runs:
#   - Quasar dev server with hot reload
#   - Nginx reverse proxy (similar to production)
#
# By default, connects to local API in Docker on shared api-network.
# See BACKEND_DOMAIN options below for other configurations.

services:
  # Quasar dev server with hot reload (internal service)
  platform-dev:
    image: node:22.18.0-alpine
    container_name: platform-dev
    working_dir: /app
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    volumes:
      - .:/app
      - /app/node_modules  # Prevent overwriting host node_modules
    env_file:
      - .env
    environment:
      - NODE_ENV=development
    networks:
      - api-network

  # Nginx with bot detection (production-like entry point)
  platform-nginx:
    image: nginx:1.25-alpine
    container_name: platform-nginx
    ports:
      - "9005:80"
    volumes:
      - ./nginx-dev.conf.template:/etc/nginx/templates/default.conf.template:ro
    environment:
      # ============================================
      # BACKEND_DOMAIN - Choose one option:
      # ============================================
      #
      # Option 1: Remote dev API (no local API needed)
      # - BACKEND_DOMAIN=https://api.dev.openmeet.net
      #
      # Option 2: Local API running on host via npm (port 3000)
      # - BACKEND_DOMAIN=http://host.docker.internal:3000
      #
      # Option 3: Local API in Docker on shared network (DEFAULT)
      - BACKEND_DOMAIN=http://api:3000
      #
      # ============================================
      - QUASAR_DEV_HOST=platform-dev:9005
      - APP_TENANT_ID=${APP_TENANT_ID}
    extra_hosts:
      - "host.docker.internal:host-gateway"  # Allows nginx to reach host machine
    depends_on:
      - platform-dev
    networks:
      - api-network

networks:
  # Shared network - works standalone or with openmeet-api
  # If openmeet-api created api-network first, this joins it
  # If standalone, creates a new api-network
  api-network:
    name: api-network
    driver: bridge
